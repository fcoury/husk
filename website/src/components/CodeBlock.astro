---
import { Code } from 'astro:components';
import huskLight from '../themes/husk-light.json';
import huskDark from '../themes/husk-dark.json';

interface Props {
  code: string;
  lang?: string;
  filename?: string;
  showCopy?: boolean;
}

// Use 'rust' for syntax highlighting since Husk is Rust-inspired
const { code, lang = 'rust', filename, showCopy = false } = Astro.props;
---

<div class="code-block">
  <div class="code-header">
    <div class="code-dots">
      <span></span>
      <span></span>
      <span></span>
      {filename && <span class="filename">{filename}</span>}
    </div>
    {showCopy && (
      <button class="copy-btn" data-code={code} aria-label="Copy to clipboard">
        <svg class="copy-icon w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </svg>
        <svg class="check-icon hidden w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5" />
        </svg>
      </button>
    )}
  </div>
  <div class="code-content">
    <Code code={code} lang={lang} themes={{ light: huskLight, dark: huskDark }} defaultColor={false} />
  </div>
</div>

<style>
  .code-block {
    position: relative;
    background: linear-gradient(135deg, var(--color-surface-800) 0%, var(--color-surface-900) 100%);
    border: 1px solid var(--color-surface-600);
    border-radius: 12px;
    overflow: hidden;
  }

  .code-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--color-surface-700);
    border-bottom: 1px solid var(--color-surface-600);
  }

  .code-dots {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .code-dots span:not(.filename) {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .code-dots span:nth-child(1) { background: #ff5f57; }
  .code-dots span:nth-child(2) { background: #febc2e; }
  .code-dots span:nth-child(3) { background: #28c840; }

  .code-dots .filename {
    margin-left: 12px;
    font-size: 12px;
    font-family: var(--font-mono, ui-monospace, monospace);
    color: rgba(255, 255, 255, 0.6);
  }

  .copy-btn {
    padding: 4px;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--color-surface-400);
    transition: color 0.2s;
  }

  .copy-btn:hover {
    color: var(--color-cream-100);
  }

  .copy-btn .check-icon {
    color: #28c840;
  }

  .copy-btn .hidden {
    display: none;
  }

  .code-content {
    padding: 16px 20px;
    font-size: 14px;
    line-height: 1.7;
    overflow-x: auto;
  }

  .code-content :global(pre) {
    margin: 0;
    padding: 0;
    background: transparent !important;
  }

  .code-content :global(code) {
    font-family: var(--font-mono, ui-monospace, monospace);
  }

  /* Always use dark theme colors since code block has dark background */
  .code-content :global(.astro-code),
  .code-content :global(.astro-code span) {
    color: var(--shiki-dark) !important;
    background-color: transparent !important;
  }
</style>

<script>
  function setupCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const code = btn.getAttribute('data-code');
        if (!code) return;

        try {
          await navigator.clipboard.writeText(code);

          const copyIcon = btn.querySelector('.copy-icon');
          const checkIcon = btn.querySelector('.check-icon');

          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');

          setTimeout(() => {
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  setupCopyButtons();
  document.addEventListener('astro:after-swap', setupCopyButtons);
</script>
