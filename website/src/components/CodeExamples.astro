---
import CodeBlock from './CodeBlock.astro';

const examples = [
  {
    id: 'pattern-matching',
    title: 'Pattern Matching',
    description: 'Exhaustive pattern matching with algebraic data types',
    code: `enum Result<T, E> {
    Ok(T),
    Err(E),
}

fn divide(a: int, b: int) -> Result<int, string> {
    if b == 0 {
        Result::Err("Division by zero")
    } else {
        Result::Ok(a / b)
    }
}

fn main() {
    match divide(10, 2) {
        Result::Ok(value) => println!("Result: {}", value),
        Result::Err(err) => println!("Error: {}", err),
    }
    // Compiler ensures all cases are handled!
}`,
  },
  {
    id: 'structs-methods',
    title: 'Structs & Methods',
    description: 'Define types with associated methods',
    code: `struct User {
    name: string,
    email: string,
    age: int,
}

impl User {
    fn new(name: string, email: string, age: int) -> User {
        User { name, email, age }
    }

    fn greet(&self) -> string {
        format!("Hi, I'm {} and I'm {} years old", self.name, self.age)
    }
}

fn main() {
    let user = User::new("Alice", "alice@example.com", 30);
    println!("{}", user.greet());
}`,
  },
  {
    id: 'js-interop',
    title: 'JavaScript Interop',
    description: 'Seamlessly use npm packages',
    code: `// Use Express.js directly from Husk
extern fn express() -> Express;

struct Express {
    extern fn get(&self, path: string, handler: fn(Request, Response) -> void) -> void;
    extern fn listen(&self, port: int, callback: fn() -> void) -> void;
}

fn main() {
    let app = express();

    app.get("/", |req, res| {
        res.send("Hello from Husk!");
    });

    app.listen(3000, || {
        println!("Server running on port 3000");
    });
}`,
  },
];
---

<section id="code" class="relative py-12 sm:py-16 overflow-hidden">
  <!-- Background -->
  <div class="absolute inset-0 grain"></div>

  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section header -->
    <div class="text-center max-w-2xl mx-auto mb-10">
      <h2 class="font-display text-3xl sm:text-4xl text-surface-900 dark:text-cream-50 mb-4">
        See it in <span class="text-husk-600 dark:text-husk-400 italic">action</span>
      </h2>
      <p class="text-base sm:text-lg text-surface-600 dark:text-cream-100/80 leading-relaxed">
        Clean, expressive syntax that compiles to readable JavaScript.
        No runtime overhead, no magic â€” just better code.
      </p>
    </div>

    <!-- Tab navigation -->
    <div class="flex flex-wrap justify-center gap-2 mb-8" role="tablist">
      {examples.map((example, index) => (
        <button
          role="tab"
          aria-selected={index === 0 ? 'true' : 'false'}
          aria-controls={`panel-${example.id}`}
          id={`tab-${example.id}`}
          data-tab={example.id}
          class={`tab-button px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-200 ${
            index === 0
              ? 'bg-husk-500 text-surface-900 shadow-lg shadow-husk-500/25'
              : 'bg-cream-200 dark:bg-surface-700 text-surface-600 dark:text-cream-100/80 hover:bg-husk-200 dark:hover:bg-husk-900/50 hover:text-surface-900 dark:hover:text-husk-300'
          }`}
        >
          {example.title}
        </button>
      ))}
    </div>

    <!-- Code panels -->
    <div class="relative">
      {examples.map((example, index) => (
        <div
          role="tabpanel"
          id={`panel-${example.id}`}
          aria-labelledby={`tab-${example.id}`}
          data-panel={example.id}
          class={`code-panel transition-all duration-300 ${index === 0 ? '' : 'hidden'}`}
        >
          <!-- Description -->
          <p class="text-center text-surface-500 dark:text-surface-400 mb-6 text-sm">
            {example.description}
          </p>

          <!-- Code block -->
          <div class="max-w-4xl mx-auto shadow-2xl shadow-surface-900/10 dark:shadow-black/30">
            <CodeBlock code={example.code} filename={`${example.id}.hk`} />
          </div>
        </div>
      ))}
    </div>

    <!-- Output preview hint -->
    <div class="mt-8 text-center">
      <div class="inline-flex items-center gap-2 px-4 py-2 bg-cream-100 dark:bg-surface-800 rounded-full border border-cream-200 dark:border-surface-700">
        <svg class="w-4 h-4 text-husk-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <span class="text-surface-600 dark:text-cream-100/80 text-sm">
          Compiles to <span class="font-mono text-husk-600 dark:text-husk-400">clean ES modules</span> or CommonJS
        </span>
      </div>
    </div>
  </div>
</section>

<script>
  // Store cleanup function for tab handlers
  let tabsCleanup: (() => void) | null = null;

  function setupTabs() {
    // Clean up previous listeners if any
    if (tabsCleanup) {
      tabsCleanup();
      tabsCleanup = null;
    }

    const tabButtons = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.code-panel');
    const handlers = new Map<Element, () => void>();

    tabButtons.forEach(button => {
      const handler = () => {
        const tabId = button.getAttribute('data-tab');

        // Update buttons
        tabButtons.forEach(btn => {
          const isActive = btn.getAttribute('data-tab') === tabId;
          btn.setAttribute('aria-selected', String(isActive));

          if (isActive) {
            btn.classList.remove('bg-cream-200', 'dark:bg-surface-700', 'text-surface-600', 'dark:text-cream-100/80');
            btn.classList.add('bg-husk-500', 'text-surface-900', 'shadow-lg', 'shadow-husk-500/25');
          } else {
            btn.classList.remove('bg-husk-500', 'text-surface-900', 'shadow-lg', 'shadow-husk-500/25');
            btn.classList.add('bg-cream-200', 'dark:bg-surface-700', 'text-surface-600', 'dark:text-cream-100/80');
          }
        });

        // Update panels
        panels.forEach(panel => {
          const isActive = panel.getAttribute('data-panel') === tabId;
          panel.classList.toggle('hidden', !isActive);
        });
      };

      button.addEventListener('click', handler);
      handlers.set(button, handler);
    });

    // Store cleanup function
    tabsCleanup = () => {
      handlers.forEach((handler, button) => {
        button.removeEventListener('click', handler);
      });
    };
  }

  setupTabs();
  document.addEventListener('astro:after-swap', setupTabs);
</script>
